<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>LHCb Starterkit: First Steps in LHCb</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css" />
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
     ga('create', 'UA-63818884-1', 'auto');
     ga('send', 'pageview');
    </script>
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="https://lhcb.github.io/first-analysis-steps/">
          <img src="img/new_starterkit.png" height="150" alt="LHCb Starterkit">
        </a>
      </div>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
          <h1 class="title">First Steps in LHCb</h1>
          <h2 class="subtitle">Developing LHCb Software</h2>
<div id="learning-objectives" class="objectives panel panel-warning">
<div class="panel-heading">
<h2 id="learning-objectives" class="objectives panel panel-warning"><span class="glyphicon glyphicon-certificate"></span>Learning Objectives</h2>
</div>
<div class="panel-body">
<ul>
<li>Learn how to work with and modify LHCb software projects and packages</li>
<li>Learn how to find and search the source code and its documentation</li>
</ul>
</div>
</div>
<div id="prerequisites" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="prerequisites" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Prerequisites</h2>
</div>
<div class="panel-body">
<p>Before starting, you should have a basic understanding of how to use <code>git</code>, similar to what has been <a href="https://lhcb.github.io/analysis-essentials/git/git.html">taught</a> during the starterkit.</p>
</div>
</div>
<p>In this lesson, we'll show you a complete workflow for developing the LHCb software using the <code>git</code> version control system. At LHCb, we use Gitlab to manage our git repositories. Among other features, Gitlab allows you to browse the source code for each project, and to review new changes (called <em>merge requests</em>) in a convenient web interface. You can find the CERN Gitlab instance at <a href="https://gitlab.cern.ch" class="uri">https://gitlab.cern.ch</a>.</p>
<p>In principle, there are multiple ways of interacting with the LHCb software repositories:</p>
<ol style="list-style-type: decimal">
<li>A vanilla git workflow using only the standard git commands. This requires you to <code>clone</code> and compile an entire LHCb project at a time.</li>
<li>An LHCb-specific workflow using a set of <code>lb-*</code> subcommands. This allows you to check out individual packages inside a project, and streamlines the modification of a few packages at a time. (This is closer to the previously used <code>getpack</code> command.)</li>
</ol>
<p>Here, we want to focus on the second workflow. The first workflow will be discussed briefly at the <a href="#working-with-a-full-project-checkout">bottom</a> of this page. Note that, although the lb-git commands are much easier for small changes to existing packages where recompiling an entire project would be cumbersome, for any serious development the usage of vanilla git is much more stable. Please consider using it if you can spare the compilation time.</p>
<div id="initial-setup" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="initial-setup" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Initial setup</h2>
</div>
<div class="panel-body">
<p>Before jumping in by creating a project in Gitlab, you should make sure that your local git configuration and your settings on Gitlab are sufficiently set up.</p>
<ul>
<li><p>Your name and email address should be set up in your local <code>git</code> configuration. To ensure that this is the case, run</p>
<pre><code>git config --global user.name &quot;Your Name&quot;
git config --global user.email &quot;Your Name &lt;your.name@cern.ch&gt;&quot;</code></pre>
<p>and put in your information.</p></li>
<li><p>Next, connect to <a href="https://gitlab.cern.ch" class="uri">https://gitlab.cern.ch</a> and log in with your CERN credentials. Visit <a href="https://gitlab.cern.ch/profile/keys" class="uri">https://gitlab.cern.ch/profile/keys</a> and add an SSH key.</p></li>
<li><p>Finally, run this LHCb-specific configuration command:</p>
<pre><code>git config --global lb-use.protocol ssh</code></pre>
<p>This makes sure the LHCb commands use the ssh protocol instead of https.</p></li>
</ul>
</div>
</div>
<p>This lesson introduces you the commands:</p>
<ul>
<li><code>lb-dev</code> for setting up a new development environment</li>
<li><code>git lb-use</code> and <code>git lb-checkout</code> for downloading LHCb software packages</li>
</ul>
<p>If you want to make changes to a software package, you will need to set up a development environment. <code>lb-dev</code> is your friend here:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">lb-dev</span> --name DaVinciDev DaVinci/v42r2</code></pre></div>
<p>The output should look similar to this:</p>
<pre><code>Successfully created the local project DaVinciDev in .

To start working:

  &gt; cd ./DaVinciDev
  &gt; git lb-use DaVinci
  &gt; git lb-checkout DaVinci/vXrY MyPackage

then

  &gt; make
  &gt; make test

and optionally (CMake only)

  &gt; make install

You can customize the configuration by editing the files &#39;build.conf&#39; and
&#39;CMakeLists.txt&#39; (see http://cern.ch/gaudi/CMake for details).</code></pre>
<div id="lb-dev-created-local-projects-are-git-repositories" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="lb-dev-created-local-projects-are-git-repositories" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span><code>lb-dev</code> created local projects are Git repositories</h2>
</div>
<div class="panel-body">
<p>When <code>lb-dev</code> creates the local project directory and create the initial files there, it also calls <code>git init</code> and commits to the local Git repository the first version of the files (try with <code>git log</code> in there).</p>
<p>You can then use git to keep track of your development, and share your code with others (for example with a <a href="https://gitlab.cern.ch/projects/new">new project in gitlab.cern.ch</a>).</p>
</div>
</div>
<p>Follow those instructions to compile the software:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">cd</span> DaVinciDev
<span class="fu">git</span> lb-use DaVinci
<span class="fu">make</span></code></pre></div>
<p>Once that's done, you can do</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">./run</span> bash -l</code></pre></div>
<p>inside the directory. This will (similar to <code>lb-run</code>) give you a new bash session with the right environment variables set, from which you can run project-specific commands such as <code>gaudirun.py</code>.</p>
<p>Your new development environment won't be very useful without any software to modify and build. So let's check out one of the existing LHCb packages! These are stored in the <a href="https://gitlab.cern.ch/lhcb">LHCb Git repositories</a>.</p>
<p>In order to obtain the source code of the package you want to work on, we'll use the <a href="https://twiki.cern.ch/twiki/bin/view/LHCb/Git4LHCb">Git4LHCb</a> scripts. These are a set of aliases, starting with <code>git lb-</code>, that are designed to make developing LHCb software easier. For example, if you want to write a custom stripping selection, execute the following in the <code>DaVinciDev</code> directory:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">git</span> lb-use Stripping
<span class="fu">git</span> lb-checkout Stripping/master Phys/StrippingSelections
<span class="fu">make</span> configure</code></pre></div>
<p>Under the hood, <code>git lb-use</code> will add the <a href="https://gitlab.cern.ch/lhcb/Stripping"><code>Stripping</code></a> repository as a remote in git – check this with <code>git remote -v</code>! <code>git lb-checkout</code> will then perform a <em>partial</em> checkout of the master branch of the Stripping repository, only adding the files under <a href="https://gitlab.cern.ch/lhcb/Stripping/tree/master/Phys/StrippingSelections"><code>Phys/StrippingSelections</code></a>.</p>
<div id="which-project-to-use-in-git-lb-use" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="which-project-to-use-in-git-lb-use" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Which project to use in <code>git lb-use</code>?</h2>
</div>
<div class="panel-body">
<p>The project name to pass to <code>git lb-use</code> depends on the directories you want to check out and work on, and not on the project name you passed to <code>lb-dev</code>. Moreover you can call <code>git lb-use</code> several times for different remote projects in the same local project:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">lb-dev</span> --name DaVinciDev DaVinci/v42r2
<span class="bu">cd</span> DaVinciDev
<span class="fu">git</span> lb-use Analysis
<span class="fu">git</span> lb-use Stripping
<span class="fu">git</span> lb-use DaVinci</code></pre></div>
<p>Not that in order for this to work, projects you specify in <code>lb-use</code> may not depend on the project you specify in <code>lb-dev</code>. In other words, the top-level project should be at the top of the <a href="http://lhcb-comp.web.cern.ch/lhcb-comp/">dependency chain</a>.</p>
</div>
</div>
<p>You can now modify the <code>StrippingSelections</code> package and run <code>make purge &amp;&amp; make</code> to build it with your changes. You can test your changes with the <code>./run</code> script. It works similar to <code>lb-run</code>, without the need to specify a package and version:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">./run</span> gaudirun.py options.py</code></pre></div>
<div id="what-if-git-asks-for-my-password" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="what-if-git-asks-for-my-password" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>What if <code>git</code> asks for my password?</h2>
</div>
<div class="panel-body">
<p>Make sure you succesfully completed the instructions under <a href="#initial-setup">initial setup</a>.</p>
</div>
</div>
<p>If you have made changes that you'd like to be integrated into the official LHCb repositories, you can use <code>git lb-push</code> to push it to a new branch in the central git repository. But please read the instructions in the <a href="https://twiki.cern.ch/twiki/bin/view/LHCb/Git4LHCb#Using_Git_for_LHCb_development">TWiki page</a> first.</p>
<p>Depending on the project, you may be required to document your changes in the release notes which are found in <code>doc/release.notes</code>.</p>
<p>Note that no-one has permission to push directly to the <code>master</code> branch of any project. In order to get your changes merged there from the branch to which you <code>lb-push</code>ed, you need to create a merge request, so the project maintainer can inspect your code. This can be done on the project repository web page, for example <a href="https://gitlab.cern.ch/lhcb/Stripping/merge_requests/new" class="uri">https://gitlab.cern.ch/lhcb/Stripping/merge_requests/new</a>.</p>
<div id="quick-link-to-create-a-merge-request" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="quick-link-to-create-a-merge-request" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Quick link to create a merge request</h2>
</div>
<div class="panel-body">
<p>When pushing to a branch in a project in Gitlab you will see a message like:</p>
<pre><code>remote:
remote: Create merge request for my-branch:
remote:   https://gitlab.cern.ch/lhcb/Stripping/merge_requests/new?merge_request%5Bsource_branch%5D=my-branch
remote:</code></pre>
<p>You can use the URL in the message to quickly create a merge request for the changes you just pushed.</p>
</div>
</div>
<p>When your merge request is approved (which can be after some additional commits on your part), your changes are part of the <code>master</code> branch of the respective project, and your contributions are officially part of the LHCb software stack. Congratulations!</p>
<div id="nightlies" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="nightlies" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Nightlies</h2>
</div>
<div class="panel-body">
<p>It is advisable to test new developments on the so-called <a href="https://lhcb-nightlies.cern.ch">nightly builds</a>. Each project is built overnight (hence the name), and all pending merge requests are applied. You can use a nightly build version of a project with:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">lb-dev</span> --nightly lhcb-head DaVinci/HEAD</code></pre></div>
<p>A more detailed description of the command is found here:</p>
<ul>
<li><a href="https://twiki.cern.ch/twiki/bin/view/LHCb/SoftwareEnvTools">SoftwareEnvTools</a></li>
</ul>
<p>Sometimes mistakes happen and the committed code is either not compiling or does not do what it is supposed to do. Therefore the nightly tests are performed. They first try to build the full software stack.</p>
<p>If that is successful, they run some reference jobs and compare the output of the new build with a reference file. The results of the nightly builds can be found here.</p>
<ul>
<li><a href="https://lhcb-nightlies.cern.ch">Nightly builds summaries</a></li>
</ul>
<p>If the aim of the commit was to change the ouput, e.g. because you increased the track reconstruction efficiency by a factor of two, mention it in the merge request description, such that the manager of the affected project can update the reference file.</p>
</div>
</div>
<p>If you want to take a look the source code, without checking it out, you can easily access the repository through the <a href="https://gitlab.cern.ch/lhcb">Gitlab web interface</a>. This website also provides search functionality, but the output is not always easy to read, especially if it returns many hits. To search a project much quicker, you can use <code>Lbglimpse</code>. It allows you to search for a given string in the source code of a particular LHCb project.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">Lbglimpse</span> <span class="st">&quot;PVRefitter&quot;</span> DaVinci v42r2</code></pre></div>
<p>This works with every LHCb project and released version. Since it's a shell command, you can easily process the output using <code>less</code>, <code>grep</code>, and other tools.</p>
<p>To get an idea of how a certain component of the LHCb software works, you can also access the doxygen documentation. One set of doxygen web pages is generated for several related projects, and is linked in all the projects web sites, like <a href="https://cern.ch/LHCb-release-area/DOC/davinci/" class="uri">https://cern.ch/LHCb-release-area/DOC/davinci/</a>. See also the the <a href="http://cern.ch/lhcb-comp/">LHCb Computing web page</a> for a list of projects.</p>
<div id="working-with-a-full-project-checkout" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="working-with-a-full-project-checkout" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Working with a full project checkout</h2>
</div>
<div class="panel-body">
<p>The <code>lb-git</code> commands are not strictly necessary, but they're very convenient if you just want to quickly edit one package. Otherwise you'd have to build the entire project in which the package is residing, instead of using the precompiled version. However, if you develop across multiple packages, or want to use more sophisticated <code>git</code> commands, nothing prevents you from checking out an entire project – just don't be surprised if it takes O(hours) to compile!</p>
<p>To check out a project, run the following:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">git</span> clone https://:@gitlab.cern.ch:8443/lhcb/DaVinci.git</code></pre></div>
<p>replacing <code>DaVinci</code> with the project name of your choice. Next, initialise and compile it:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">lb-project-init</span> make</code></pre></div>
<p>optionally followed by <code>make test</code> to run the tests and/or <code>make install</code> to install it to the <code>InstallArea</code> directory. That's all! You now have a vanilla git repository containing all the source files of the project.</p>
</div>
</div>
        </div>
      </div>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/lhcb/first-analysis-steps">Source</a>
        <a class="label swc-blue-bg" href="mailto:lhcb-starterkit@cern.ch">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/contrib/auto-render.min.js"></script>
    <script>
      // Go KaTeX go!
      renderMathInElement(document.body);
    </script>
  </body>
</html>
