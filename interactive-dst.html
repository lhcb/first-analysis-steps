<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>LHCb Starterkit: First Steps in LHCb</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css" />
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
     ga('create', 'UA-63818884-1', 'auto');
     ga('send', 'pageview');
    </script>
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="https://lhcb.github.io/first-analysis-steps/">
          <img src="img/new_starterkit.png" height="150" alt="LHCb Starterkit">
        </a>
      </div>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
          <h1 class="title">First Steps in LHCb</h1>
          <h2 class="subtitle">Interactively exploring a DST</h2>
<div id="learning-objectives" class="objectives panel panel-warning">
<div class="panel-heading">
<h2 id="learning-objectives" class="objectives panel panel-warning"><span class="glyphicon glyphicon-certificate"></span>Learning Objectives</h2>
</div>
<div class="panel-body">
<ul>
<li>Open a DST in an interactive python session</li>
<li>Print all nodes in a DST</li>
<li>Explore the contents of the TES</li>
<li>Inspect a track</li>
<li>Inspect a stripping location</li>
</ul>
</div>
</div>
<p>Data is stored in files called DSTs, which are processed by DaVinci to make nTuples. However you can also explore them interactively from a python session.</p>
<p>This is particularly useful if you want to quickly find something out, or the more complex processing in DaVinci is not working as expected.</p>
<p>The file we <a href="files-from-grid.html">downloaded from the grid</a> contains simulated data, with stripping and trigger decisions and so on. Here we assumed the file you downloaded is called <code>00035742_00000002_1.allstreams.dst</code>. To take a look at the contents of the TES, we need to write a small Python file:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> sys

<span class="im">import</span> GaudiPython <span class="im">as</span> GP
<span class="im">from</span> GaudiConf <span class="im">import</span> IOHelper
<span class="im">from</span> Configurables <span class="im">import</span> DaVinci

dv <span class="op">=</span> DaVinci()
dv.DataType <span class="op">=</span> <span class="st">&#39;2012&#39;</span>

<span class="co"># Pass file to open as first command line argument</span>
inputFiles <span class="op">=</span> [sys.argv[<span class="op">-</span><span class="dv">1</span>]]
IOHelper(<span class="st">&#39;ROOT&#39;</span>).inputFiles(inputFiles)

appMgr <span class="op">=</span> GP.AppMgr()
evt <span class="op">=</span> appMgr.evtsvc()

appMgr.run(<span class="dv">1</span>)
evt.dump()</code></pre></div>
<p>Place this into a file called <code>first.py</code> and run the following command in a new terminal:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="ex">lb-run</span> DaVinci/v41r2 ipython -i first.py 00035742_00000002_1.allstreams.dst</code></pre></div>
<p>This will open the DST and print out some of the TES locations which exist for this event. We are now ready to explore the TES, which is accessible via the <code>evt</code> variable. For example you could look at the properties of some tracks for the first event by typing inside the python session:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">tracks <span class="op">=</span> evt[<span class="st">&#39;/Event/Rec/Track/Best&#39;</span>]
<span class="bu">print</span> tracks[<span class="dv">0</span>]</code></pre></div>
<p>The next question is, how do you know what TES locations that could exist? As we saw <code>evt.dump()</code> prints a few of them, but not all. In addition there are some special ones that only exist if you try to access them. The following snippet allows you to discover most TES locations that are interesting:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> nodes(evt, node<span class="op">=</span><span class="va">None</span>):
    <span class="co">&quot;&quot;&quot;List all nodes in `evt`&quot;&quot;&quot;</span>
    nodenames <span class="op">=</span> []

    <span class="cf">if</span> node <span class="kw">is</span> <span class="va">None</span>:
        root <span class="op">=</span> evt.retrieveObject(<span class="st">&#39;&#39;</span>)
        node <span class="op">=</span> root.registry()

    <span class="cf">if</span> node.<span class="bu">object</span>():
        nodenames.append(node.identifier())
        <span class="cf">for</span> l <span class="kw">in</span> evt.leaves(node):
            <span class="co"># skip a location that takes forever to load</span>
            <span class="co"># XXX How to detect these automatically??</span>
            <span class="cf">if</span> <span class="st">&#39;Swum&#39;</span> <span class="kw">in</span> l.identifier():
                <span class="cf">continue</span>

            temp <span class="op">=</span> evt[l.identifier()]
            nodenames <span class="op">+=</span> nodes(evt, l)

    <span class="cf">else</span>:
        nodenames.append(node.identifier())

    <span class="cf">return</span> nodenames</code></pre></div>
<p>The easiest way to use it is to add it to your <code>first.py</code> script and re-run it with <code>ipython -i first.py 00035742_00000002_1.allstreams.dst</code>. This will list a large number of TES locations, but even so there are some which you have to know about. Another oddity is that some locations are &quot;packed&quot;, for example: <code>/Event/AllStreams/pPhys/Particles</code>. You can not access these directly at this location. Instead you have to know what location the contents will get unpacked to when you want to use it. Often you can just try removing the small <code>p</code> from the location (<code>/Event/AllStreams/Phys/Particles</code>).</p>
<p>You can also inspect the particles and vertices built by your stripping line. However not every event will contain a candidate for your line, so the first tool we need is something that will advance us until the stripping decision was positive:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> advance(decision):
    <span class="co">&quot;&quot;&quot;Advance until stripping decision is true, returns</span>
<span class="co">    number of events by which we advanced&quot;&quot;&quot;</span>
    n <span class="op">=</span> <span class="dv">0</span>
    <span class="cf">while</span> <span class="va">True</span>:
        appMgr.run(<span class="dv">1</span>)

        <span class="cf">if</span> <span class="kw">not</span> evt[<span class="st">&#39;/Event/Rec/Header&#39;</span>]:
            <span class="bu">print</span> <span class="st">&#39;Reached end of input files&#39;</span>
            <span class="cf">break</span>

        n <span class="op">+=</span> <span class="dv">1</span>
        dec<span class="op">=</span>evt[<span class="st">&#39;/Event/Strip/Phys/DecReports&#39;</span>]
        <span class="cf">if</span> dec.hasDecisionName(<span class="st">&#39;Stripping</span><span class="sc">{0}</span><span class="st">Decision&#39;</span>.<span class="bu">format</span>(decision)):
            <span class="cf">break</span>

    <span class="cf">return</span> n</code></pre></div>
<p>Add this to your script and restart <code>ipython</code> as before.</p>
<div id="detecting-file-ends" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="detecting-file-ends" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Detecting file ends</h2>
</div>
<div class="panel-body">
<p>It is not easy to detect that the input file has ended. Especially if you want to get it right for data and simulation. Checking that <code>/Event/Rec/Header</code> exists is a safe bet in simulation and data if your file has been processed by <code>Brunel</code> (the event reconstruction software). It might not work in other cases.</p>
</div>
</div>
<p>Using the name of our stripping line we can now advance through the DST until we reach an event which contains a candidate:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">line <span class="op">=</span> <span class="st">&#39;D2hhCompleteEventPromptDst2D2RSLine&#39;</span>
advance(line)</code></pre></div>
<p>The candidates built for you can now be found at <code>/Event/AllStreams/Phys/D2hhCompleteEventPromptDst2D2RSLine/Particles</code>:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">cands <span class="op">=</span> evt[<span class="st">&#39;/Event/AllStreams/Phys/D2hhCompleteEventPromptDst2D2RSLine/Particles&#39;</span>]
<span class="bu">print</span> cands.size()</code></pre></div>
<p>This tells you how many candidates there are in this event and you can access the first one with:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="bu">print</span> cands[<span class="dv">0</span>]</code></pre></div>
<p>Which will print out some information about the <a href="http://lhcb-release-area.web.cern.ch/LHCb-release-area/DOC/davinci/releases/v41r2/doxygen/d0/d13/class_l_h_cb_1_1_particle.html#details">Particle</a>. In our case a D*. You can access its daughters with <code>cands[0].daughtersVector()[0]</code> and <code>cands[0].daughtersVector()[1]</code>, which will be a D0 and a pion.</p>
<p>There is a useful tool for printing out decay trees, which you can pass the top level particle to and it will print out the daughters etc:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">print_decay <span class="op">=</span> appMgr.toolsvc().create(
  <span class="st">&#39;PrintDecayTreeTool&#39;</span>, interface<span class="op">=</span><span class="st">&#39;IPrintDecayTreeTool&#39;</span>
)
print_decay.printTree(cands[<span class="dv">0</span>])</code></pre></div>
<p>With our candidates in hand, it would be nice to be able to retrieve and compute the variables we need for an analysis. On to <a href="loki-functors.html">LoKi functors</a>!</p>
<div id="fast-dst-browsing" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="fast-dst-browsing" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Fast DST browsing</h2>
</div>
<div class="panel-body">
<p>While here we have discussed for pedagogical reasons all the configuration options needed in order to browse a <code>DST</code> file, in your daily life as a physicist it is often useful to use the <code>bender</code> application that belongs to the <code>Bender</code> project.</p>
<p>For example, to explore the <code>DST</code> we could have simply done:</p>
<pre><code>lb-run Bender/latest bender 00035742_00000002_1.allstreams.dst</code></pre>
<p>This leaves us in a prompt in which we can proceed as discussed in this lesson, with the advantage that some functions are already provided for us, such as <code>seekStripDecision</code> (which replaces our <code>advance</code>) or <code>ls</code> and <code>get</code>, which allow to list and get TES locations. Other examples of useful functions are listed in the <code>bender</code> starting banner.</p>
<p><code>Bender</code> also provides a useful command <code>dst-dump</code>, which is a quick way of figuring out what objects are present on a <code>DST</code> and where. Try out:</p>
<pre><code>lb-run Bender/latest dst-dump -f -n 100 00035742_00000002_1.allstreams.dst</code></pre>
<p>The <code>-f</code> option tells <code>Bender</code> to try and &quot;unpack&quot; the locations such as <code>/Event/AllStreams/pPhys/Particles</code> that we mentioned above, while <code>-n 100</code> tells it to only process the first 100 events on the <code>DST</code>. Give this a try if you're ever stuck figuring out where your candidates are hiding!</p>
</div>
</div>
        </div>
      </div>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/lhcb/first-analysis-steps">Source</a>
        <a class="label swc-blue-bg" href="mailto:lhcb-starterkit@cern.ch">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/contrib/auto-render.min.js"></script>
    <script>
      // Go KaTeX go!
      renderMathInElement(document.body);
    </script>
  </body>
</html>
